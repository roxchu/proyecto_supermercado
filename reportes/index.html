<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Ventas - Supermercado</title>
    <link rel="stylesheet" href="../paneles/dashboard_admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .report-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .report-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .metric-value {
            font-weight: bold;
            color: #007bff;
        }
        
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .neutral { color: #6c757d; }
        
        .btn-report {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn-report:hover {
            background: #0056b3;
        }
        
        .report-section {
            margin: 30px 0;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .top-products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .product-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #28a745;
        }
        
        .date-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .date-selector input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> Reportes de Ventas</h1>
            <a href="../paneles/dashboard_admin.php" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Panel
            </a>
        </header>

        <!-- Botones de reportes rápidos -->
        <div class="reports-grid">
            <div class="report-card">
                <h3><i class="fas fa-calendar-day"></i> Reporte Diario</h3>
                <button class="btn-report" onclick="generarReporte('diario')">
                    Generar Reporte del Día
                </button>
            </div>
            
            <div class="report-card">
                <h3><i class="fas fa-calendar-week"></i> Reporte Semanal</h3>
                <button class="btn-report" onclick="generarReporte('semanal')">
                    Generar Reporte de la Semana
                </button>
            </div>
            
            <div class="report-card">
                <h3><i class="fas fa-calendar-alt"></i> Reporte Mensual</h3>
                <button class="btn-report" onclick="generarReporte('mensual')">
                    Generar Reporte del Mes
                </button>
            </div>
            
            <div class="report-card">
                <h3><i class="fas fa-calendar"></i> Reporte Anual</h3>
                <button class="btn-report" onclick="generarReporte('anual')">
                    Generar Reporte del Año
                </button>
            </div>
        </div>

        <!-- Selector de fechas personalizadas -->
        <div class="report-section">
            <h3><i class="fas fa-calendar-check"></i> Reporte Personalizado</h3>
            <div class="date-selector">
                <label>Fecha Inicio:</label>
                <input type="date" id="fechaInicio" value="<?php echo date('Y-m-01'); ?>">
                
                <label>Fecha Fin:</label>
                <input type="date" id="fechaFin" value="<?php echo date('Y-m-d'); ?>">
                
                <button class="btn-report" onclick="generarReportePersonalizado()">
                    Generar Reporte
                </button>
            </div>
        </div>

        <!-- Área de resultados -->
        <div id="resultados" style="display: none;">
            <!-- Métricas principales -->
            <div class="report-section">
                <h3><i class="fas fa-chart-bar"></i> Métricas Principales</h3>
                <div class="reports-grid" id="metricas">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>

            <!-- Comparación con período anterior -->
            <div class="report-section">
                <h3><i class="fas fa-exchange-alt"></i> Comparación con Período Anterior</h3>
                <div id="comparacion">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>

            <!-- Productos más vendidos -->
            <div class="report-section">
                <h3><i class="fas fa-star"></i> Productos Más Vendidos</h3>
                <div class="top-products" id="topProductos">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>

            <!-- Ventas por día -->
            <div class="report-section">
                <h3><i class="fas fa-chart-line"></i> Ventas por Día</h3>
                <div class="chart-container">
                    <canvas id="ventasChart"></canvas>
                </div>
            </div>

            <!-- Estadísticas de empleados -->
            <div class="report-section">
                <h3><i class="fas fa-users"></i> Rendimiento de Empleados</h3>
                <div id="empleadosStats">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Generando reporte...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let ventasChart = null;

        function mostrarLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultados').style.display = 'none';
        }

        function ocultarLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        async function generarReporte(tipo) {
            mostrarLoading();
            
            try {
                const response = await fetch('generar_reporte.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tipo: tipo })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    mostrarResultados(data.reporte);
                } else {
                    alert('Error al generar reporte: ' + data.message);
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            } finally {
                ocultarLoading();
            }
        }

        async function generarReportePersonalizado() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                alert('Por favor selecciona ambas fechas');
                return;
            }
            
            if (fechaInicio > fechaFin) {
                alert('La fecha de inicio debe ser anterior a la fecha de fin');
                return;
            }
            
            mostrarLoading();
            
            try {
                const response = await fetch('generar_reporte.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        tipo: 'personalizado',
                        fechaInicio: fechaInicio,
                        fechaFin: fechaFin
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    mostrarResultados(data.reporte);
                } else {
                    alert('Error al generar reporte: ' + data.message);
                }
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            } finally {
                ocultarLoading();
            }
        }

        function mostrarResultados(reporte) {
            document.getElementById('resultados').style.display = 'block';
            
            // Mostrar métricas principales
            mostrarMetricas(reporte);
            
            // Mostrar comparación
            mostrarComparacion(reporte.comparacion_periodos);
            
            // Mostrar productos top
            mostrarTopProductos(reporte.detalle_productos);
            
            // Mostrar gráfico de ventas
            mostrarGraficoVentas(reporte.ventas_por_dia);
            
            // Mostrar estadísticas de empleados
            mostrarEstadisticasEmpleados(reporte);
        }

        function mostrarMetricas(reporte) {
            const metricas = document.getElementById('metricas');
            metricas.innerHTML = `
                <div class="report-card">
                    <h4><i class="fas fa-dollar-sign"></i> Total Ventas</h4>
                    <div class="metric">
                        <span>Total:</span>
                        <span class="metric-value">$${formatearNumero(reporte.total_ventas)}</span>
                    </div>
                    <div class="metric">
                        <span>Transacciones:</span>
                        <span class="metric-value">${reporte.cantidad_transacciones}</span>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4><i class="fas fa-store"></i> Ventas Presenciales</h4>
                    <div class="metric">
                        <span>Total:</span>
                        <span class="metric-value">$${formatearNumero(reporte.ventas_presenciales)}</span>
                    </div>
                    <div class="metric">
                        <span>Porcentaje:</span>
                        <span class="metric-value">${calcularPorcentaje(reporte.ventas_presenciales, reporte.total_ventas)}%</span>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4><i class="fas fa-laptop"></i> Ventas Virtuales</h4>
                    <div class="metric">
                        <span>Total:</span>
                        <span class="metric-value">$${formatearNumero(reporte.ventas_virtuales)}</span>
                    </div>
                    <div class="metric">
                        <span>Porcentaje:</span>
                        <span class="metric-value">${calcularPorcentaje(reporte.ventas_virtuales, reporte.total_ventas)}%</span>
                    </div>
                </div>
                
                <div class="report-card">
                    <h4><i class="fas fa-receipt"></i> Ticket Promedio</h4>
                    <div class="metric">
                        <span>Promedio:</span>
                        <span class="metric-value">$${formatearNumero(reporte.total_ventas / reporte.cantidad_transacciones || 0)}</span>
                    </div>
                </div>
            `;
        }

        function mostrarComparacion(comparacion) {
            const comparacionDiv = document.getElementById('comparacion');
            const cambioVentas = comparacion.cambios.ventas_porcentaje;
            const cambioTransacciones = comparacion.cambios.transacciones_porcentaje;
            
            comparacionDiv.innerHTML = `
                <div class="reports-grid">
                    <div class="metric">
                        <span>Cambio en Ventas:</span>
                        <span class="${cambioVentas >= 0 ? 'positive' : 'negative'}">
                            ${cambioVentas >= 0 ? '+' : ''}${cambioVentas}%
                            <i class="fas fa-arrow-${cambioVentas >= 0 ? 'up' : 'down'}"></i>
                        </span>
                    </div>
                    <div class="metric">
                        <span>Cambio en Transacciones:</span>
                        <span class="${cambioTransacciones >= 0 ? 'positive' : 'negative'}">
                            ${cambioTransacciones >= 0 ? '+' : ''}${cambioTransacciones}%
                            <i class="fas fa-arrow-${cambioTransacciones >= 0 ? 'up' : 'down'}"></i>
                        </span>
                    </div>
                    <div class="metric">
                        <span>Diferencia en Ventas:</span>
                        <span class="${comparacion.cambios.diferencia_ventas >= 0 ? 'positive' : 'negative'}">
                            $${formatearNumero(Math.abs(comparacion.cambios.diferencia_ventas))}
                        </span>
                    </div>
                </div>
            `;
        }

        function mostrarTopProductos(productos) {
            const topProductos = document.getElementById('topProductos');
            topProductos.innerHTML = productos.map((producto, index) => `
                <div class="product-card">
                    <h4>#${index + 1} ${producto.Nombre_Producto}</h4>
                    <div class="metric">
                        <span>Código:</span>
                        <span>${producto.codigo_producto}</span>
                    </div>
                    <div class="metric">
                        <span>Vendidos:</span>
                        <span class="metric-value">${producto.total_vendido}</span>
                    </div>
                    <div class="metric">
                        <span>Ingresos:</span>
                        <span class="metric-value">$${formatearNumero(producto.ingresos_producto)}</span>
                    </div>
                    <div class="metric">
                        <span>Precio Prom:</span>
                        <span>$${formatearNumero(producto.precio_promedio)}</span>
                    </div>
                </div>
            `).join('');
        }

        function mostrarGraficoVentas(ventasPorDia) {
            const ctx = document.getElementById('ventasChart').getContext('2d');
            
            if (ventasChart) {
                ventasChart.destroy();
            }
            
            const labels = ventasPorDia.map(v => formatearFecha(v.fecha));
            const data = ventasPorDia.map(v => parseFloat(v.total_ventas));
            
            ventasChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas Diarias',
                        data: data,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + formatearNumero(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Ventas: $' + formatearNumero(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }

        function mostrarEstadisticasEmpleados(reporte) {
            // Esta función se implementaría si tenemos datos de empleados en el reporte
            const empleadosDiv = document.getElementById('empleadosStats');
            empleadosDiv.innerHTML = '<p>Estadísticas de empleados disponibles próximamente.</p>';
        }

        function formatearNumero(numero) {
            return new Intl.NumberFormat('es-AR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numero);
        }

        function formatearFecha(fecha) {
            return new Date(fecha + 'T00:00:00').toLocaleDateString('es-AR', {
                day: '2-digit',
                month: '2-digit'
            });
        }

        function calcularPorcentaje(parte, total) {
            return total > 0 ? ((parte / total) * 100).toFixed(1) : 0;
        }
    </script>
</body>
</html>